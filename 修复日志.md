# 2023.1.11

## 1.vscode debug无法成功启动

![image-20230111190556834](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img3/image-20230111190556834.png)

launch.json配置如上，来源是example，只设置结构体成员type、name、request时，其他成员为默认状态无需更改

![image-20230111190821539](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img3/image-20230111190821539.png)

出现上述报错时，点击取消后再次尝试。一般第二次尝试则会正常

![image-20230111191021913](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img3/image-20230111191021913.png)

其全部output如下：

```
[OpenOCD]
Open On-Chip Debugger v0.11.0-esp32-20221026 (2022-10-26-14:48)
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.org/doc/doxygen/bugs.html
[OpenOCD]
debug_level: 2

[OpenOCD]
adapter speed: 20000 kHz

[OpenOCD]
Info : Listening on port 6666 for tcl connections
[OpenOCD]
Info : Listening on port 4444 for telnet connections
[OpenOCD]
❌ Error: libusb_open() failed with LIBUSB_ERROR_NOT_SUPPORTED
[OpenOCD]
Info : ftdi: if you experience problems at higher adapter clocks, try the command "ftdi tdo_sample_edge falling"
Info : clock speed 20000 kHz
Info : JTAG tap: esp32.cpu0 tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)
Info : JTAG tap: esp32.cpu1 tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)
Info : starting gdb server for esp32.cpu0 on 3333
Info : Listening on port 3333 for gdb connections
[OpenOCD]
Info : [esp32.cpu0] Debug controller was reset.
[OpenOCD]
Info : [esp32.cpu0] Core was reset.
[OpenOCD]
Info : [esp32.cpu1] Debug controller was res[OpenOCD]
et.
Info : [esp32.cpu1] Core was reset.
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40162BA4, debug_reason=00000000
[OpenOCD]
Info : [esp32.cpu0] [OpenOCD]
Reset cause (12) - (Software CPU0 reset)
[Debug Adapter]
DEBUG_ADAPTER_STARTED
2023-01-11 19:08:01,617 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_STARTED
[Debug Adapter]
DEBUG_ADAPTER_READY2CONNECT
2023-01-11 19:08:01,622 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_READY2CONNECT
[OpenOCD]
Info : [esp32.cpu1] Target halted, PC=0x40162BA4, debug_reason=00000000
Info : [esp32.cpu1] Reset cause (12) - (Software CPU1 reset)
[Debug Adapter]
DEBUG_ADAPTER_STOPPED
2023-01-11 19:08:06,916 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_STOPPED
[Stopped] : ESP-IDF Debug Adapter
[Debug Adapter]
DEBUG_ADAPTER_STARTED
2023-01-11 19:09:57,795 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_STARTED
[Debug Adapter]
DEBUG_ADAPTER_READY2CONNECT
2023-01-11 19:09:57,799 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_READY2CONNECT
[Debug Adapter]
DEBUG_ADAPTER_STOPPED
2023-01-11 19:10:03,075 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_STOPPED
[Stopped] : ESP-IDF Debug Adapter
[Debug Adapter]
DEBUG_ADAPTER_STARTED
2023-01-11 19:10:07,256 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_STARTED
[Debug Adapter]
DEBUG_ADAPTER_READY2CONNECT
2023-01-11 19:10:07,260 - Debug Adapter (main) - CRITICAL - Debug adapter -> Extension: DEBUG_ADAPTER_READY2CONNECT
[OpenOCD]
Info : accepting 'gdb' connection on tcp/3333
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40162BA4,[OpenOCD]
 debug_reason=00000000
[OpenOCD]
Info : Set GDB target to 'esp32.cpu0'
[OpenOCD]
Info : [esp32.cpu1] Target halted, PC=0x40162BA4, debug_reason=00000000
[OpenOCD]
Warn : No symbols for FreeRTOS!
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
Info : Flash mapping 1: 0x3[OpenOCD]
0020 -> 0x400d0020, 616 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Auto-detected flash bank 'esp32.cpu0.flash' size 4096 KB
Info : Using flash bank 'esp32.cpu0.flash' size 4096 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
Info : Flash mapping 1: 0x30020 -> 0x4[OpenOCD]
00d0020, 616 KB
Info : Using flash bank 'esp32.cpu0.irom' size 620 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
Info : Flash mapping 1: 0x300[OpenOCD]
20 -> 0x400d0020, 616 KB
Info : Using flash bank 'esp32.cpu0.drom' size 92 KB
Info : New GDB Connection: 1, Target esp32.cpu0, state: halted
[OpenOCD]
Warn : Prefer GDB command "target extended-remot[OpenOCD]
e :3333" instead of "target remote :3333"
[OpenOCD]
Info : JTAG tap: esp32.cpu0 tap/device found: 0x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)
Info : JTAG tap: esp32.cpu1 tap/device found: 0[OpenOCD]
x120034e5 (mfg: 0x272 (Tensilica), part: 0x2003, ver: 0x1)
[OpenOCD]
Info : [esp32.cpu0] requesting target halt and executing a soft reset
[OpenOCD]
Info : [esp32.cpu0] Debug controller was reset.
[OpenOCD]
Info : [esp32.cpu0] Core was reset.
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x500000CF, debug_reason=00000000
[OpenOCD]
Info : [esp32.cpu0] Reset cause (3) - (Software core reset)
[OpenOCD]
Info : [esp32.cpu1] requesting target halt and executing a soft reset[OpenOCD]

[OpenOCD]
Info : [esp32.cpu0] Core was reset.
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40000400, debug_r[OpenOCD]
eason=00000000
[OpenOCD]
Info : [esp32.cpu1] Debug controller was reset.
[OpenOCD]
Info : [esp32.cpu1] Core was reset.
[OpenOCD]
Info : [esp32.cpu1] Target halted, PC=0x40000400, debug_r[OpenOCD]
eason=00000000
[OpenOCD]
Info : [esp32.cpu1] Reset cause (14) - (CPU1 reset by CPU0)
[OpenOCD]
Info : [esp32.cpu0] Reset cause (3) [OpenOCD]
- (Software core reset)
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
Info : Flash mapping 1: 0x30020 -> 0x400d0020, 616 KB
Info : Using flash bank 'esp32.cpu0.irom' size 620 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
[OpenOCD]
Info : Flash mapping 1: 0x30020 -> 0x400d0020, 616 KB
Info : Using flash bank 'esp32.cpu0.drom' size 92 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
[OpenOCD]
Info : Flash mapping 1: 0x30020 -> 0x400d0020, 616 KB
Info : Using flash bank 'esp32.cpu1.irom' size 620 KB
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x40092612, debug_reason=00000001
[OpenOCD]
Info : Flash mapping 0: 0x10020 -> 0x3f400020, 90 KB
[OpenOCD]
Info : Flash mapping 1: 0x30020 -> 0x400d0020, 616 KB
Info : Using flash bank 'esp32.cpu1.drom' size 92 KB
[OpenOCD]
Info : dropped 'gdb' connection
[OpenOCD]
Info : accepting 'gdb' connection on tcp/3333
[OpenOCD]
Info : New GDB Connection: 1, Target esp32.cpu0, state: halted
[OpenOCD]
Info : [esp32.cpu0] Target halted, PC=0x400D8E35, debug_reason=00000001
[OpenOCD]
Info : Set GDB target to 'esp32.cpu0'
[OpenOCD]
Info : [esp32.cpu1] Target halted, PC=0x40162BA4, debug_reason=00000000

```



## 2、nvs

### 2.1 open其nvs分区为空时会打开失败

解决方案：

```c
 err = nvs_open("storage", NVS_READONLY, &my_handle);
    if (err == ESP_OK) {
        ...
    }
 nvs_close(my_handle);
```

当检测到分区为空时将不再进行以下操作并关闭分区

### 2.2没擦除nvs导致有时cpu崩溃

解决方案

```c
err = nvs_open("storage", NVS_READONLY, &my_handle);
    if (err == ESP_OK) {
        ...
    }
nvs_flash_erase(); 
nvs_close(my_handle);
```

每次第一次读完会擦除所有数据，原本是写一个‘0’进去。但是不知道为什么导致了崩溃，然后就改成了擦除的API。

### 3、更换了分析与发送的逻辑顺序

![image-20230111200057052](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img3/image-20230111200057052.png)

在原版本中，先分析flag1然后进行发送并置位flag3。其逻辑顺位接下来是解析，但如果直接进行下一步解析，此时所需要解析的数据并没有完成接收，也就无法解析。而flag3却已经置零，当再次接收到数据时，将无法进入解析。

解决方案：

```c
if (Flag3 == 1 && Flag1 == 1) {
    printf("\nCommand analysis!!!\n");
    printf("the data is %s\n", tcp_rx_buffer);
    //printf("Flag1=%d,Flag3=%d\n", Flag1, Flag3);
    Flag1 = 0;
    command_json_analysis(len, tcp_rx_buffer, kSock1);
    vTaskDelay(1000 / portTICK_PERIOD_MS);
}

if (Flag1 == 1) //确认接收到COM心跳
{
	written = send(kSock1, kHeartRet, 5, 0);
	Flag3 = 1; //确认好心跳OK发送完整
	//printf("Flag1=%d,Flag3=%d", Flag1, Flag3);
}
```

将两者的逻辑顺序调换既可

### 4.指令包整合

![image-20230111201134350](https://raw.githubusercontent.com/xutongxin1/PictureBed/master/img3/image-20230111201134350.png)

目前用的是if，但是可以换成swtich

```c
if (str_command == 101) {
	strattach = pattach->valuestring;
	str_attach = (*strattach);
	if (str_attach != '0' && str_attach <= '9' && str_attach >= '1') {
	cJSON_Delete(pJsonRoot);//释放节点
	nvs_flash_write(str_attach, ksock);//写入flash
	send(ksock, kHeartRet, 5, 0);//
	int s_1 = shutdown(ksock, 0);
	int s_2 = close(ksock);
	printf("\nYou are closing the connection %d %d %d.\n", kSock1, s_1, s_2);
	printf("Restarting now.\n");
	fflush(stdout);
	esp_restart(); //重启函数，esp断电重连
}
```



**注意，顺序应该是释放json根节点->模式写入flash->发送心跳包->关闭/断开tcp协议->重启**

（1）发送心跳包以及模式写入flash，必须在关闭/断开tcp协议之前

（2）重启一定在最后

顺序可以在遵从（1），（2）的前提下稍作更改

